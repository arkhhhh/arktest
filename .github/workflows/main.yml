name: arktest

on:
    push:
      branches: [ "dev", "release", "main" ]
    workflow_dispatch:

env:
  IMAGE_NAME: 'arktest-image'
  GCP_PROJECT_ID: 'ak-central-matrix'
  AR_REPO_LOCATION: 'asia-east1'
  AR_URL: 'asia-east1-docker.pkg.dev/ak-central-matrix/akousist-registry'
  SERVICE_ACCOUNT: 'githubactions@ak-central-matrix.iam.gserviceaccount.com' 
  WORKLOAD_IDENTITY_PROVIDER: 'projects/198927898038/locations/global/workloadIdentityPools/githubactions/providers/githubactions-prvdr'

jobs:
  Initiating:
    permissions:
      contents: 'read'
      id-token: 'write'

    runs-on: ubuntu-latest
    outputs:
      build_tag: ${{ steps.setenv.outputs.build_tag }}
    steps:
      - name: Initiating env variables'
        id: setenv
        run: |-
          if [ "${{ github.ref }}" == "refs/heads/dev" ]; then
            echo "BUILD_TAG=${{ github.run_number }}"
            echo "build_tag=${{ github.run_number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/release" ]; then
            TAG=$(echo $GITHUB_SHA | cut -c1-7)
            TAG="rc-$TAG"
            echo "BUILD_TAG=$TAG"
            echo "build_tag=$TAG" >>$GITHUB_OUTPUT
          fi

  Build:
    needs: Initiating
    permissions:
      contents: 'read'
      id-token: 'write'

    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.capture_status.outputs.build_status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Do somthing
        continue-on-error: true
        id: building
        run: |
          echo "There something running here..."
          exit 1

      - name: Capture build status
        id: capture_status
        run: |
          if [ "${{ steps.building.outcome }}" == "success" ]; then
            echo "build_status=0"  
            echo "build_status=0" >> $GITHUB_OUTPUT
          else
            echo "build_status=1"
            echo "build_status=1" >> $GITHUB_OUTPUT
          fi

  Notify:
    needs: [Initiating, Build]
    permissions:
      contents: 'read'
      id-token: 'write'
    env:
      BUILD_TAG: ${{ needs.Initiating.outputs.build_tag }}
      BUILD_STATUS: ${{ needs.Build.outputs.build_status }}
    runs-on: ubuntu-latest
    steps:
      - name: Successed Notify
        id: notify_successed
        uses: slackapi/slack-github-action@v2.0.0
        if: env.BUILD_STATUS == 0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: 'ðŸ“£ SHOUT OUT ðŸ‘‰${{ env.IMAGE_NAME }}ðŸ‘ˆ'
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: 'âœ… *Finish and ready for Deploy*'
              - type: "section"
                fields: [
                  {
                    "type": "mrkdwn",
                    "text": "ðŸŽ¯*Repo*\n*${{ env.IMAGE_NAME }}*"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "ðŸ”–*Tag:*\n*${{ env.BUILD_TAG }}*"
                  }
                ]
              - type: "divider"
              - type: "section"
                fields: [
                  {
                    "type": "mrkdwn",
                    "text": "ðŸª´*Branch:*\n*${{ github.ref }}*"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "ðŸ‘¾*Revision:*\n*${{ github.sha }}*"
                  }
                ]
          

      - name: Failed Notify
        id: notify_failed
        uses: slackapi/slack-github-action@v2.0.0
        if: env.BUILD_STATUS != 0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: 'ðŸ›‘ GG ðŸ‘‰${{ env.IMAGE_NAME }}ðŸ‘ˆ'
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: 'ðŸ›‘ *${{ env.IMAGE_NAME }}* build failed!'                  
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: 'Details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
                  
          